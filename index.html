<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Interattiva di Roma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #map {
            height: 100vh;
        }
        
        .custom-icon {
            font-size: 24px;
        }
        
        .btn-close {
            font-size: 1.5rem;
        }
        
        .audio-btn,
        .directions-btn {
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div id="header" class="position-fixed top-0 w-100 bg-light p-2 d-flex justify-content-between align-items-center">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <span id="headerTitle">Roma Interattiva</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#progettoModal">Progetto</a></li>
                <li><a class="dropdown-item" href="https://www.paypal.com/donate/?hosted_button_id=L5R8GJK2L85VC" target="_blank">Sostienici ‚ù§Ô∏è</a></li>
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy</a></li>
            </ul>
        </div>
        <div class="dropdown">
            <button id="languageSelector" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                üáÆüáπ Italiano
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-lang="it">üáÆüáπ Italiano</a></li>
                <li><a class="dropdown-item" data-lang="en">üá¨üáß English</a></li>
                <li><a class="dropdown-item" data-lang="fr">üá´üá∑ Fran√ßais</a></li>
                <li><a class="dropdown-item" data-lang="es">üá™üá∏ Espa√±ol</a></li>
            </ul>
        </div>
    </div>

    <!-- Modals for Progetto, Privacy, and POI info -->
    <div class="modal fade" id="progettoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Progetto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="progettoContent"></p>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="privacyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Privacy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="privacyContent"></p>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="poiModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button class="btn btn-secondary audio-btn">‚ñ∂Ô∏è Audio</button>
                    <button class="btn btn-primary directions-btn">
                        <i class='fas fa-route' style='font-size:24px'></i>                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img class="img-fluid mb-3" alt="">
                    <p></p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://kit.fontawesome.com/yourcode.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBz4NRyHo04pEwVNwPwTJznmAT1usblayg&callback=initMap" async defer></script>
    <script>
        let map, currentLang = 'it',
            poiData = [],
            userMarker, userAccuracyCircle, userBeam;
        let currentUtterance = null;

        const modalContent = {
            progetto: {
                it: "Scopri Roma come mai prima d'ora! La nostra app √® una mappa interattiva che ti guider√† tra i tesori storici e artistici della Capitale. Immagina di passeggiare tra le strade acciottolate, mentre un curatore virtuale ti racconta storie affascinanti su monumenti iconici come il Colosseo e il Pantheon. Non solo avrai accesso a informazioni dettagliate su ogni punto di interesse, ma anche aneddoti divertenti e curiosit√† che renderanno ogni visita un‚Äôesperienza indimenticabile. Sia che tu sia un turista in cerca di avventure o un romano che desidera riscoprire la propria citt√†, la nostra guida virtuale √® il compagno perfetto per esplorare la bellezza senza tempo di Roma!",
                en: "Discover Rome like never before! Our app is an interactive map that will guide you through the historical and artistic treasures of the Eternal City. Imagine strolling down cobblestone streets while a virtual curator shares captivating stories about iconic landmarks like the Colosseum and the Pantheon. You won't just get detailed information about each point of interest, but also fun anecdotes and trivia that make every visit an unforgettable experience. Whether you're a tourist seeking adventures or a local wanting to rediscover your city, our virtual guide is the perfect companion for exploring the timeless beauty of Rome!",
                fr: "D√©couvrez Rome comme jamais auparavant ! Notre application est une carte interactive qui vous guidera √† travers les tr√©sors historiques et artistiques de la Ville √âternelle. Imaginez-vous fl√¢ner dans des rues pav√©es pendant qu'un conservateur virtuel vous raconte des histoires fascinantes sur des monuments embl√©matiques tels que le Colis√©e et le Panth√©on. Vous aurez acc√®s non seulement √† des informations d√©taill√©es sur chaque point d'int√©r√™t, mais aussi √† des anecdotes amusantes et √† des faits qui rendront chaque visite inoubliable. Que vous soyez un touriste en qu√™te d'aventures ou un romain souhaitant red√©couvrir sa ville, notre guide virtuel est le compagnon parfait pour explorer la beaut√© intemporelle de Rome!",
                es: "¬°Descubre Roma como nunca antes! Nuestra app es un mapa interactivo que te guiar√° a trav√©s de los tesoros hist√≥ricos y art√≠sticos de la Ciudad Eterna. Imagina pasear por calles empedradas mientras un curador virtual comparte historias cautivadoras sobre monumentos ic√≥nicos como el Coliseo y el Pante√≥n. No solo tendr√°s acceso a informaci√≥n detallada sobre cada punto de inter√©s, sino tambi√©n a an√©cdotas divertidas y curiosidades que har√°n de cada visita una experiencia inolvidable. Ya seas un turista en busca de aventuras o un romano que desea redescubrir su ciudad, nuestra gu√≠a virtual es el compa√±ero perfecto para explorar la belleza atemporal de Roma."
            },
            privacy: {
                it: "Testo della privacy policy di Roma Interattiva.",
                en: "Privacy policy of Interactive Rome.",
                fr: "Politique de confidentialit√© de Rome Interactive.",
                es: "Pol√≠tica de privacidad de Roma Interactiva."
            }
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 41.9028,
                    lng: 12.4964
                },
                zoom: 13,
                zoomControl: false, // Aggiunta questa linea
                streetViewControl: false, // Aggiunta questa linea
                styles: [{
                    featureType: "all",
                    elementType: "geometry",
                    stylers: [{
                        color: "#f5f5f5"
                    }]
                }, {
                    featureType: "road",
                    elementType: "geometry",
                    stylers: [{
                        color: "#ffffff"
                    }]
                }, {
                    featureType: "water",
                    elementType: "geometry",
                    stylers: [{
                        color: "#e9e9e9"
                    }]
                }, {
                    featureType: "poi",
                    stylers: [{
                        visibility: "off"
                    }]
                }, {
                    featureType: "transit.station",
                    elementType: "labels.icon",
                    stylers: [{
                        visibility: "on"
                    }]
                }]
            });

            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(createCustomControl());

            loadPOIData();
            setupEventListeners();
            startLocationTracking();
            updateLanguage();
        }

        function createCustomControl() {
            const controlButton = document.createElement('button');
            controlButton.style.cssText = `
        background-color: #fff;
        border: none;
        border-radius: 2px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        cursor: pointer;
        margin-right: 10px;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
    `;

            const targetIcon = document.createElement('div');
            targetIcon.innerHTML = '&#9678;';
            targetIcon.style.cssText = `
        font-size: 24px;
        color: black;
    `;

            controlButton.appendChild(targetIcon);
            controlButton.addEventListener('click', centerMapOnUser);

            return controlButton;
        }

        function loadPOIData() {
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vR1s7NnwxoebCo5g_ajvJsVuDkVWxZvVX9nTZLmWC4goLzPdpdFhdoK8WW6NofzEsgVrnKugfRcUrSk/pub?output=csv', {
                download: true,
                header: true,
                complete: result => {
                    poiData = result.data.map(row => ({
                        name: {
                            it: row.name,
                            en: row.name_en,
                            fr: row.name_fr,
                            es: row.name_es
                        },
                        category: row.category,
                        lat: parseFloat(row.lat),
                        lng: parseFloat(row.lon),
                        description: {
                            it: row.description_it,
                            en: row.description_en,
                            fr: row.description_fr,
                            es: row.description_es
                        },
                        img: row.img,
                        imgsrc: row.imgsrc,
                        audio: {
                            it: row.audio_it,
                            en: row.audio_en,
                            fr: row.audio_fr,
                            es: row.audio_es
                        }
                    }));
                    poiData.forEach(createMarker);
                }
            });
        }

        function createMarker(poi) {
            const marker = new google.maps.Marker({
                position: {
                    lat: poi.lat,
                    lng: poi.lng
                },
                map: map,
                icon: {
                    url: `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><text x="12" y="20" font-family="Arial" font-size="20" fill="black" text-anchor="middle">${getIconForCategory(poi.category)}</text></svg>`,
                    scaledSize: new google.maps.Size(30, 30)
                }
            });
            marker.addListener('click', () => showPOIModal(poi));
        }

        function getIconForCategory(category) {
            return {
                monumenti: 'üèõÔ∏è',
                chiese: '‚úùÔ∏è',
                edifici: 'üè¢',
                varie: 'üëÅÔ∏è'
            }[category] || '';
        }

        function showPOIModal(poi) {
            const modal = new bootstrap.Modal(document.getElementById('poiModal'));
            const modalTitle = document.querySelector('#poiModal .modal-title');
            const modalBody = document.querySelector('#poiModal .modal-body');
            const audioBtn = document.querySelector('#poiModal .audio-btn');
            const directionsBtn = document.querySelector('#poiModal .directions-btn');

            modalTitle.textContent = poi.name[currentLang] || poi.name.it;

            // Create a new anchor element
            const imgLink = document.createElement('a');
            imgLink.href = poi.imgsrc;
            imgLink.target = "_blank"; // Open in a new tab

            // Get the existing img element
            const imgElement = modalBody.querySelector('img');

            // Set the image properties
            imgElement.src = poi.img;
            imgElement.alt = modalTitle.textContent;

            // Remove the img from its current position (if it exists)
            if (imgElement.parentNode) {
                imgElement.parentNode.removeChild(imgElement);
            }

            // Append the img to the new anchor element
            imgLink.appendChild(imgElement);

            // Replace the existing img in the modal body with the new anchor+img
            const oldImg = modalBody.querySelector('img');
            if (oldImg) {
                modalBody.replaceChild(imgLink, oldImg);
            } else {
                modalBody.insertBefore(imgLink, modalBody.firstChild);
            }

            modalBody.querySelector('p').textContent = poi.description[currentLang] || poi.description.it;

            audioBtn.onclick = () => toggleAudio(poi.description[currentLang]); // Solo testo nella lingua selezionata
            directionsBtn.onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${poi.lat},${poi.lng}`);

            modal.show();
        }

        function toggleAudio(text) {
            const audioBtn = document.querySelector('.audio-btn');

            if (speechSynthesis.speaking) {
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                    audioBtn.textContent = '‚è∏Ô∏è Audio';
                } else {
                    speechSynthesis.pause();
                    audioBtn.textContent = '‚ñ∂Ô∏è Audio';
                }
            } else {
                if (currentUtterance) {
                    speechSynthesis.cancel();
                }
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = currentLang;

                currentUtterance.onend = () => {
                    audioBtn.textContent = '‚ñ∂Ô∏è Audio';
                    currentUtterance = null;
                };

                currentUtterance.onpause = () => {
                    audioBtn.textContent = '‚ñ∂Ô∏è Audio';
                };

                currentUtterance.onresume = () => {
                    audioBtn.textContent = '‚è∏Ô∏è Audio';
                };

                speechSynthesis.speak(currentUtterance);
                audioBtn.textContent = '‚è∏Ô∏è Audio';
            }
        }

        function stopAudio() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                document.querySelector('.audio-btn').textContent = '‚ñ∂Ô∏è Audio';
                currentUtterance = null;
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.dropdown-item[data-lang]').forEach(item => {
                item.addEventListener('click', function() {
                    currentLang = this.getAttribute('data-lang');
                    updateLanguage();
                });
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('hidden.bs.modal', stopAudio);
            });
        }

        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateUserLocation, error => console.error('Error:', error), {
                    enableHighAccuracy: true,
                    maximumAge: 30000,
                    timeout: 27000
                });
            } else {
                alert('Il tuo browser non supporta la geolocalizzazione.');
            }
        }

        function updateUserLocation(position) {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            const svgMarker = {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeColor: '#FFFFFF',
                strokeWeight: 2,
                scale: 10
            };

            const accuracyCircle = {
                strokeColor: '#4285F4',
                strokeOpacity: 0.2,
                strokeWeight: 1,
                fillColor: '#4285F4',
                fillOpacity: 0.1,
                map: map,
                center: pos,
                radius: position.coords.accuracy
            };

            if (!userMarker) {
                userMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    icon: svgMarker
                });

                userAccuracyCircle = new google.maps.Circle(accuracyCircle);
            } else {
                userMarker.setPosition(pos);
                userAccuracyCircle.setCenter(pos);
                userAccuracyCircle.setRadius(position.coords.accuracy);
            }
        }

        function centerMapOnUser() {
            if (userMarker) {
                map.setCenter(userMarker.getPosition());
                map.setZoom(16);
            }
        }

        function updateLanguage() {
            const languageSelector = document.getElementById('languageSelector');
            const headerTitle = document.getElementById('headerTitle');
            const progettoContent = document.getElementById('progettoContent');
            const privacyContent = document.getElementById('privacyContent');

            languageSelector.textContent = document.querySelector(`.dropdown-item[data-lang="${currentLang}"]`).textContent;

            headerTitle.textContent = {
                it: "Roma Interattiva",
                en: "Interactive Rome",
                fr: "Rome Interactive",
                es: "Roma Interactiva"
            }[currentLang] || "Roma Interattiva";

            progettoContent.textContent = modalContent.progetto[currentLang];
            privacyContent.textContent = modalContent.privacy[currentLang];

            // Cambia l'audio della descrizione in base alla lingua selezionata
            if (currentUtterance) {
                speechSynthesis.cancel(); // Cancella l'utterance corrente
                currentUtterance = new SpeechSynthesisUtterance(progettoContent.textContent);
                currentUtterance.lang = currentLang; // Imposta la nuova lingua
                speechSynthesis.speak(currentUtterance); // Riproduci il nuovo audio
            }
        }

        window.initMap = initMap;
    </script>
</body>

</html>