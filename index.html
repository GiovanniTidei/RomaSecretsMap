<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mappa Interattiva di Roma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background-color: rgba(255, 255, 255, 0) !important;
            height: 50px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        
        #content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #map-container {
            flex: 0 0 70%;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #ad-space {
            flex: 0 0 30%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .custom-icon {
            font-size: 24px;
        }
        
        .audio-btn,
        .directions-btn {
            margin-left: 10px;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }
        
        .modal-dialog {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            z-index: 1020;
            /* Assicurati che il titolo stia sopra il contenuto durante lo scorrimento */
            background-color: white;
            /* Mantieni lo sfondo visibile quando √® fisso */
        }
        
        .modal-body {
            overflow-y: auto;
            /* Attiva lo scroll solo sul corpo */
        }
        
        .modal-content {
            max-height: calc(90vh - 60px);
            overflow-y: auto;
        }
        
        .locate-control {
            position: absolute;
            bottom: 35px;
            right: 10px;
        }
        
        .locate-control button {
            background-color: white;
            border: 2px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            bottom: 35%;
            /* Spostato in basso a destra */
            right: 2%;
            z-index: 1000;
        }
        
        .locate-control button i {
            color: #000;
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div id="header" class="position-fixed top-0 w-100 bg-light p-2 d-flex justify-content-between align-items-center">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <span id="headerTitle">Roma Interattiva</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#progettoModal">Progetto</a></li>
                <li><a class="dropdown-item" href="https://www.paypal.com/donate/?hosted_button_id=L5R8GJK2L85VC" target="_blank">Sostienici ‚ù§Ô∏è</a></li>
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy</a></li>
            </ul>
        </div>
        <div class="dropdown">
            <button id="languageSelector" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <span id="languageSelectorText">üáÆüáπ Italiano</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-lang="it">üáÆüáπ Italiano</a></li>
                <li><a class="dropdown-item" data-lang="en">üá¨üáß English</a></li>
                <li><a class="dropdown-item" data-lang="fr">üá´üá∑ Fran√ßais</a></li>
                <li><a class="dropdown-item" data-lang="es">üá™üá∏ Espa√±ol</a></li>
            </ul>
        </div>
    </div>

    <div id="content-wrapper">
        <div id="map-container">
            <div id="map"></div>
            <div class="locate-control">
                <button id="locateButton">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
        <div id="ad-space">
            <p>Spazio Pubblicitario</p>
        </div>
    </div>

    <div class="modal fade" id="progettoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Progetto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="progettoContent"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="privacyModal" tabindex="-1">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Privacy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="privacyContent"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="poiModal" tabindex="-1" aria-labelledby="poiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="poiModalLabel">POI Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="poiModalImage" src="" alt="" class="img-fluid mb-3">
                    <p id="poiModalDescription"></p>
                </div>
                <div class="modal-footer">
                    <!-- Pulsanti aggiunti nel footer -->
                    <button class="btn btn-sm btn-outline-secondary me-2" style="width: 40px; height: 40px; padding: 0; display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" style="width: 40px; height: 40px; padding: 0; display: flex; justify-content: center; align-items: center;" id="routeButton">
                        <i class="fas fa-route"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>

    <script>
        // Coordinate di Roma
        var rome = ol.proj.fromLonLat([12.4964, 41.9028]);

        // Creazione della mappa
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: 'https://cartodb-basemaps-{a-d}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'
                    })
                })
            ],
            view: new ol.View({
                center: rome,
                zoom: 13
            }),
            controls: ol.control.defaults({
                zoom: false, // Disabilita il controllo di zoom
                attribution: true // Mantieni il controllo del copyright
            })
        });


        var userPositionMarker;
        var userPositionFeature;
        var currentLang = 'it'; // Lingua predefinita

        // Funzione per richiedere la geolocalizzazione
        function requestGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                        map.getView().setCenter(coords);
                        map.getView().setZoom(16);
                        addUserPositionMarker(coords);
                    },
                    function(error) {
                        console.error('Errore nella geolocalizzazione:', error);
                    }, {
                        enableHighAccuracy: true
                    }
                );
            } else {
                console.error('Il browser non supporta la geolocalizzazione.');
            }
        }

        // Funzione per aggiungere il marker della posizione dell'utente
        function addUserPositionMarker(coords) {
            if (!userPositionFeature) {
                userPositionFeature = new ol.Feature({
                    geometry: new ol.geom.Point(coords)
                });

                var userPositionStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({
                            color: 'blue'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 2
                        })
                    })
                });

                userPositionMarker = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [userPositionFeature]
                    }),
                    style: userPositionStyle
                });

                map.addLayer(userPositionMarker);
            } else {
                userPositionFeature.getGeometry().setCoordinates(coords);
            }
        }

        // Funzione associata al pulsante di localizzazione
        var locateButton = document.getElementById('locateButton');
        locateButton.addEventListener('click', function() {
            requestGeolocation();
        });

        // Aggiorna la posizione dell'utente ogni 5 secondi
        setInterval(function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                        addUserPositionMarker(coords);
                    },
                    function(error) {
                        console.error('Errore nell\'aggiornamento della posizione:', error);
                    }, {
                        enableHighAccuracy: true
                    }
                );
            } else {
                console.error('Il browser non supporta la geolocalizzazione.');
            }
        }, 2000);

        // Funzione per caricare i dati dei POI dal CSV
        function loadPOIData() {
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vR1s7NnwxoebCo5g_ajvJsVuDkVWxZvVX9nTZLmWC4goLzPdpdFhdoK8WW6NofzEsgVrnKugfRcUrSk/pub?output=csv', {
                download: true,
                header: true,
                complete: result => {
                    const poiData = result.data.map(row => ({
                        name: {
                            it: row.name,
                            en: row.name_en,
                            fr: row.name_fr,
                            es: row.name_es
                        },
                        category: row.category,
                        lat: parseFloat(row.lat),
                        lng: parseFloat(row.lon),
                        description: {
                            it: row.description_it,
                            en: row.description_en,
                            fr: row.description_fr,
                            es: row.description_es
                        },
                        img: row.img,
                        imgsrc: row.imgsrc,
                    }));
                    poiData.forEach(createMarker);
                }
            });
        }

        // Funzione per creare i marker sulla mappa
        function createMarker(poi) {
            const coords = ol.proj.fromLonLat([poi.lng, poi.lat]);
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coords),
                name: poi.name,
                description: poi.description,
                category: poi.category,
                lat: poi.lat,
                lng: poi.lng
            });

            const markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    src: `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><text x="12" y="20" font-family="Arial" font-size="20" fill="black" text-anchor="middle">${getIconForCategory(poi.category)}</text></svg>`,
                    scale: 1
                })
            });

            marker.setStyle(markerStyle);

            const vectorSource = new ol.source.Vector({
                features: [marker]
            });

            const vectorLayer = new ol.layer.Vector({
                source: vectorSource
            });

            map.addLayer(vectorLayer);

            // Aggiungi un event listener per il click sul marker
            map.on('click', function(evt) {
                map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    if (feature === marker) {
                        showModal(poi);
                    }
                });
            });
        }

        // Funzione per ottenere l'icona in base alla categoria
        function getIconForCategory(category) {
            return {
                monumenti: 'üèõÔ∏è',
                chiese: '‚úùÔ∏è',
                edifici: 'üè¢',
                varie: 'üëÅÔ∏è'
            }[category] || '';
        }

        // Funzione per mostrare il modal con i dettagli del POI
        function showModal(poi) {
            const modal = document.getElementById('poiModal');
            const modalTitle = document.getElementById('poiModalLabel');
            const modalBody = document.getElementById('poiModalDescription');
            const routeButton = document.getElementById('routeButton');

            modalTitle.textContent = poi.name.it;

            modalBody.innerHTML = `<img src="${poi.img}" alt="${poi.name.it}" class="img-fluid mb-3" onclick="window.open('${poi.imgsrc}', '_blank')">
        <p>${poi.description.it}</p>
    `;
            // Aggiungi la funzionalit√† al pulsante route nel footer
            routeButton.onclick = function() {
                openGoogleMaps(poi.lat, poi.lng);
            };

            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        // Cambio lingua pulsante
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function(event) {
                const selectedLang = event.target.dataset.lang; // Ottieni il valore della lingua selezionata
                const selectedText = event.target.textContent; // Ottieni il testo della lingua selezionata

                // Verifica se la lingua selezionata √® valida (non "Progetto" o "Privacy")
                if (selectedLang) {
                    // Aggiorna il pulsante con il testo della lingua selezionata
                    document.getElementById('languageSelectorText').textContent = selectedText;

                    // Cambia la lingua nel modal
                    changeLanguage(selectedLang); // Chiama la funzione per cambiare la lingua nel modal

                    // Stampa un messaggio per il debug
                    console.log(`Lingua selezionata: ${selectedLang}`);
                }
            });
        });
        // Funzione per aprire Google Maps con le indicazioni stradali
        function openGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Carica i dati dei POI al caricamento della pagina
        loadPOIData();
        // Abilita la rotazione della mappa
        map.addInteraction(new ol.interaction.DragRotate({
            condition: ol.events.condition.altKeyOnly
        }));

        // Aggiungi l'interazione di trascinamento per dispositivi touch
        map.addInteraction(new ol.interaction.DragPan());

        // Aggiungi l'interazione di rotazione con due dita per dispositivi touch
        map.addInteraction(new ol.interaction.Rotate({
            condition: ol.events.condition.touch
        }));

        // Inizializza la geolocalizzazione
        requestGeolocation();
    </script>
</body>

</html>