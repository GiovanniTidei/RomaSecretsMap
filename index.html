<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MiraRoma</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background-color: rgba(255, 255, 255, 0) !important;
            height: 50px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        
        #content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #map-container {
            flex: 0 0 100%;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /*   pER SPAZIO PUBBLICITARIO, ridurre map-container a 70%      
        #ad-space {
            flex: 0 0 30%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        } */
        /* togli freccia dal dropdown principale */
        
        .no-arrow.dropdown-toggle::after {
            display: none !important;
        }
        
        .custom-icon {
            font-size: 24px;
        }
        
        .audio-btn,
        .directions-btn {
            margin-left: 10px;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }
        
        .modal-dialog {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            z-index: 1020;
            /* Assicurati che il titolo stia sopra il contenuto durante lo scorrimento */
            background-color: white;
            /* Mantieni lo sfondo visibile quando √® fisso */
        }
        
        .modal-body {
            overflow-y: auto;
            /* Attiva lo scroll solo sul corpo */
        }
        
        .modal-content {
            max-height: calc(90vh - 60px);
            overflow-y: auto;
        }
        
        .locate-control {
            position: absolute;
            bottom: 35px;
            right: 10px;
        }
        
        .locate-control button {
            background-color: white;
            border: 2px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            bottom: 35%;
            /* Spostato in basso a destra */
            right: 2%;
            z-index: 1000;
        }
        
        .locate-control button i {
            color: #000;
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div id="header" class="position-fixed top-0 w-100 bg-light p-2 d-flex justify-content-between align-items-center">
        <div class="dropdown navbar-brand">
            <button class="btn btn-dark dropdown-toggle fw-bold fs-4 mt-3 no-arrow" type="button" data-bs-toggle="dropdown">
                <span id="headerTitle">Mira Roma</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#progettoModal">Progetto</a></li>
                <li><a class="dropdown-item" href="https://www.paypal.com/donate/?hosted_button_id=L5R8GJK2L85VC" target="_blank">Sostienici ‚ù§Ô∏è</a></li>
                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy</a></li>
                <li><a class="dropdown-item" id="addNewPOI">Segnala un nuovo punto d'interesse</a></li>

            </ul>
        </div>
        <div class="dropdown">
            <button id="languageSelector" class="btn btn-dark dropdown-toggle fs-4 mt-3" type="button" data-bs-toggle="dropdown">
                <span id="languageSelectorText">üáÆüáπ Italiano</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" data-lang="it">üáÆüáπ Italiano</a></li>
                <li><a class="dropdown-item" data-lang="en">üá¨üáß English</a></li>
                <li><a class="dropdown-item" data-lang="fr">üá´üá∑ Fran√ßais</a></li>
                <li><a class="dropdown-item" data-lang="es">üá™üá∏ Espa√±ol</a></li>
                <!-- <li><a class="dropdown-item" data-lang="lat">üá™Latino</a></li> -->
            </ul>
        </div>
    </div>

    <!-- nuovo poi-->
    <div class="modal fade" id="newPOIForm" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Segnala un nuovo punto d'interesse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="poiSubmissionForm">
                        <div class="mb-3">
                            <label for="poiName" class="form-label">Nome del punto d'interesse</label>
                            <input type="text" class="form-control" id="poiName" required>
                        </div>
                        <div class="mb-3">
                            <label for="poiDescription" class="form-label">Descrizione</label>
                            <textarea class="form-control" id="poiDescription" rows="3" required></textarea>
                        </div>
                        <input type="hidden" id="poiLat">
                        <input type="hidden" id="poiLng">
                        <button type="submit" class="btn btn-primary">Invia segnalazione</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div id="content-wrapper">
        <div id="map-container">
            <div id="map"></div>
            <div class="locate-control">
                <button id="locateButton">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
        <!-- pubblicit√† -->
        <div id="ad-space">
            <p></p>
        </div>
    </div>
    <!-- bottone destro Miraroma oscurato -->
    <div class="modal fade" id="progettoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><strong>MiraRoma</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="progettoContent">
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="privacyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Privacy Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Ultimo aggiornamento:</strong> 23/10/2024</p>

                    <h6>Introduzione</h6>
                    <p>
                        La presente Privacy Policy descrive come raccogliamo, utilizziamo e proteggiamo i dati personali degli utenti nell'uso dell'applicazione "MiraRoma" ("l'Applicazione"). MiraRoma si impegna a rispettare la privacy degli utenti e a proteggere i loro dati
                        personali in conformit√† con il Regolamento Generale sulla Protezione dei Dati (GDPR) e la normativa italiana sulla protezione dei dati personali (D.Lgs. 196/2003, "Codice della Privacy").
                    </p>

                    <h6>1. Informazioni che raccogliamo</h6>
                    <p>
                        MiraRoma non raccoglie, conserva o condivide dati personali degli utenti. Tuttavia, l'Applicazione pu√≤ accedere temporaneamente alla posizione corrente dell'utente per fornire funzionalit√† specifiche, come la visualizzazione di contenuti o servizi personalizzati
                        in base alla posizione. Questi dati di posizione non vengono conservati, condivisi o utilizzati per scopi commerciali.
                    </p>

                    <h6>2. Uso dei dati di posizione</h6>
                    <p>
                        I dati di posizione degli utenti vengono utilizzati esclusivamente per fornire servizi in tempo reale all'interno dell'Applicazione, come la visualizzazione della posizione corrente su una mappa o l'individuazione di punti di interesse nelle vicinanze.
                        Questi dati vengono trattati esclusivamente localmente sul dispositivo dell'utente e non vengono trasmessi a server esterni o a terze parti.
                    </p>

                    <h6>3. Sicurezza</h6>
                    <p>
                        MiraRoma adotta misure tecniche e organizzative adeguate per proteggere i dati di posizione degli utenti durante il loro utilizzo temporaneo, impedendo accessi non autorizzati, perdite o usi impropri.
                    </p>

                    <h6>4. Diritti degli utenti</h6>
                    <p>
                        Gli utenti hanno il diritto di:
                        <ul>
                            <li>Disattivare la condivisione della posizione tramite le impostazioni del dispositivo.</li>
                            <li>Richiedere ulteriori informazioni su come i loro dati di posizione vengono utilizzati all'interno dell'Applicazione.</li>
                        </ul>
                    </p>

                    <h6>5. Modifiche alla presente Privacy Policy</h6>
                    <p>
                        MiraRoma si riserva il diritto di aggiornare o modificare questa Privacy Policy in qualsiasi momento. In caso di modifiche sostanziali, informeremo gli utenti tramite notifiche all'interno dell'Applicazione o attraverso il nostro sito web.
                    </p>

                    <h6>6. Contatti</h6>
                    <p>
                        Per qualsiasi domanda o chiarimento riguardo questa Privacy Policy, √® possibile contattarci all'indirizzo email: <a href="mailto:gmt91@protonmail.com">gmt91@protonmail.com</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="poiModal" tabindex="-1" aria-labelledby="poiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="poiModalLabel">POI Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- l'img viene generata nella funzione showModal -->
                    <p id="poiModalDescription"></p>
                </div>
                <div class="modal-footer d-flex justify-content-start">
                    <!-- Pulsanti aggiunti nel footer -->
                    <button class="btn btn-lg btn-outline-secondary me-2" style="width: 40px; height: 40px; padding: 0; display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-lg btn-outline-primary" style="width: 40px; height: 40px; padding: 0; display: flex; justify-content: center; align-items: center;" id="routeButton">
                        <i class="fas fa-route"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <footer id="sticky-footer" class="py-4 bg-dark text-white-50">
        <div class="container text-center">
            <p>Magnificentia Romae omnibus est</p>
            <p><a href="https://www.paypal.com/donate/?hosted_button_id=L5R8GJK2L85VC" class="text-decoration-none text-white">Sostieni l'app con una donazione</a> <a href="https://www.paypal.com/donate/?hosted_button_id=L5R8GJK2L85VC" class="text-decoration-none"
                    style="color: red;">‚ô•</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
    <!-- <script src="js/config.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/map.js"></script>
    <script src="js/location.js"></script>
    <script src="js/poi.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/language.js"></script>
    <script src="js/app.js"></script> -->
    <script>
        ////

        ////quando seleziono una nuova lingua, il menu dropdwon dece chiudersi, inoltre dopo che ho inviato il nuoov pjnto di interesse rimane impossibile clioccare, deve resettarsi il vecchio status

        ////
        // Coordinate di Roma
        let rome = ol.proj.fromLonLat([12.474601, 41.897344]);
        // Creazione della mappa
        let map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: 'https://cartodb-basemaps-{a-d}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'
                            // url: 'https://cartodb-basemaps-{a-c}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png'
                    })
                })
            ],
            view: new ol.View({
                center: rome,
                zoom: 14
            }),
            controls: ol.control.defaults({
                zoom: false,
                attribution: true
            })
        });

        let userPositionMarker;
        let userPositionFeature;
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let isPlaying = false;
        let currentLang = 'it';
        let currentLanguage = 'it';
        let loadedPOIs = new Set(); // Per tenere traccia dei POI gi√† caricati

        //nn serve
        // function changeLanguage(lang) {
        //     currentLanguage = lang;
        // }

        //add new poi
        let isSelectingLocation = false;
        let vectorLayers = [];
        let tempMarker = null;
        const newPOIFormModal = new bootstrap.Modal(document.getElementById('newPOIForm'));
        const navbarBrand = document.querySelector('.navbar-brand');
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const originalDropdownHTML = dropdownToggle.innerHTML;
        let isSubmitting = false;

        // Gestore per il pulsante "Segnala un nuovo punto d'interesse"
        document.getElementById('addNewPOI').addEventListener('click', function() {
            // Chiudi il dropdown menu
            const dropdownMenu = this.closest('.dropdown-menu');
            const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
            const bsDropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
            if (bsDropdown) {
                bsDropdown.hide();
            }
            isSelectingLocation = true;
            dropdownToggle.innerHTML = `<strong>${translations[currentLanguage].whereQuestion}</strong>`;
            dropdownToggle.classList.remove('btn-dark');
            dropdownToggle.classList.add('btn-danger');

            // Nascondi temporaneamente SOLO i layer dei POI, non il marker utente
            map.getLayers().getArray()
                .filter(layer => {
                    // Verifica se il layer √® un Vector layer ma NON √® il marker utente
                    return layer instanceof ol.layer.Vector && layer !== userPositionMarker;
                })
                .forEach(layer => {
                    vectorLayers.push(layer);
                    map.removeLayer(layer);
                });

            // Disabilita i controlli UI ma mantieni visibile il marker utente
            toggleUIElements(true);
        });


        // Gestore click sulla mappa
        map.on('click', function(evt) {
            if (!isSelectingLocation) return;

            const coords = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
            const lat = coords[1];
            const lng = coords[0];

            // Aggiungi marker temporaneo
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }

            const tempFeature = new ol.Feature({
                geometry: new ol.geom.Point(evt.coordinate)
            });

            const tempStyle = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({
                        color: 'red'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'white',
                        width: 2
                    })
                })
            });

            tempMarker = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [tempFeature]
                }),
                style: tempStyle
            });

            map.addLayer(tempMarker);

            // Popola i campi nascosti con le coordinate
            document.getElementById('poiLat').value = lat;
            document.getElementById('poiLng').value = lng;

            // Mostra il form
            newPOIFormModal.show();
        });

        // Gestione chiusura form
        document.getElementById('newPOIForm').addEventListener('hidden.bs.modal', function() {
            // Rimuovi il marker temporaneo
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Ripristina i layer dei marker originali solo se non stiamo inviando il form
            if (!isSubmitting) {
                // Ripristina i layer originali
                vectorLayers.forEach(layer => map.addLayer(layer));
                vectorLayers = [];

                // Reset completo dello stato e dell'interfaccia
                resetUICompletely();
            }

            // Reset del form
            document.getElementById('poiSubmissionForm').reset();
        });


        // Gestione invio form
        document.getElementById('poiSubmissionForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (isSubmitting) return; // Previene invii multipli
            isSubmitting = true;
            isSelectingLocation = false; // Disabilita immediatamente la selezione sulla mappa

            const formData = {
                name: document.getElementById('poiName').value,
                description: document.getElementById('poiDescription').value,
                lat: document.getElementById('poiLat').value,
                lng: document.getElementById('poiLng').value,
                timestamp: new Date().toISOString()
            };

            // Rimuovi immediatamente il marker temporaneo
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Ripristina immediatamente i layer dei marker originali
            vectorLayers.forEach(layer => map.addLayer(layer));
            vectorLayers = [];

            // Ripristina immediatamente il dropdown originale
            dropdownToggle.innerHTML = originalDropdownHTML;
            dropdownToggle.classList.remove('btn-danger');
            dropdownToggle.classList.add('btn-dark');

            // Chiudi il modal
            newPOIFormModal.hide();

            // Invia i dati al Google Sheet
            submitToGoogleSheet(formData);
        });

        function submitToGoogleSheet(data) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbzj77FWD85OXnT_35LU5_-uhXd3uPt9YC-SrgDZDHWSR3ATtuB65nYd3PVO6Guu2YMGAg/exec';

            const successMessage = document.createElement('div');
            successMessage.className = 'position-fixed top-50 start-50 translate-middle bg-dark text-white p-3 rounded';
            successMessage.style.zIndex = '1000';
            successMessage.innerHTML = `<strong>${translations[currentLanguage].thankYouMessage}</strong>`;

            fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(() => {
                    // Mostra il messaggio di successo
                    document.body.appendChild(successMessage);
                    setTimeout(() => {
                        successMessage.remove();
                    }, 3000);

                    // Reset completo dello stato
                    document.getElementById('poiSubmissionForm').reset();

                    // Rimuovi il marker temporaneo
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }

                    // Ripristina i layer originali
                    vectorLayers.forEach(layer => map.addLayer(layer));
                    vectorLayers = [];

                    // Reset completo dell'interfaccia
                    resetUICompletely();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Si √® verificato un errore durante l\'invio della segnalazione');
                    resetUICompletely();
                })
                .finally(() => {
                    isSubmitting = false;
                });
        }

        function resetPOISelection() {
            isSelectingLocation = false;
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Ripristina i layer dei marker originali
            vectorLayers.forEach(layer => map.addLayer(layer));
            vectorLayers = [];

            // Reset form
            document.getElementById('poiSubmissionForm').reset();

            // Ripristina il dropdown originale
            dropdownToggle.innerHTML = originalDropdownHTML;
            dropdownToggle.classList.remove('btn-danger');
            dropdownToggle.classList.add('btn-dark');
        }

        // Funzione per richiedere la geolocalizzazione
        function requestGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                        map.getView().setCenter(coords);
                        map.getView().setZoom(16);
                        addUserPositionMarker(coords);
                    },
                    function(error) {
                        console.error('Errore nella geolocalizzazione:', error);
                    }, {
                        enableHighAccuracy: true
                    }
                );
            } else {
                console.error('Il browser non supporta la geolocalizzazione.');
            }
        }

        function addUserPositionMarker(coords) {
            if (!userPositionFeature) {
                userPositionFeature = new ol.Feature({
                    geometry: new ol.geom.Point(coords)
                });

                var userPositionStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({
                            color: 'blue'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 4
                        })
                    })
                });

                userPositionMarker = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [userPositionFeature]
                    }),
                    style: userPositionStyle
                });

                map.addLayer(userPositionMarker);
            } else {
                userPositionFeature.getGeometry().setCoordinates(coords);
            }
        }

        var locateButton = document.getElementById('locateButton');
        locateButton.addEventListener('click', function() {
            requestGeolocation();
        });

        setInterval(function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                        addUserPositionMarker(coords);
                    },
                    function(error) {
                        console.error('Errore nell\'aggiornamento della posizione:', error);
                    }, {
                        enableHighAccuracy: true
                    }
                );
            }
        }, 2000);

        // Funzione modificata per caricare i POI in base alla viewport
        function loadPOIData() {
            const jsonUrl = 'punti_interesse.json';
            const currentExtent = map.getView().calculateExtent(map.getSize());
            const bufferedExtent = ol.extent.buffer(currentExtent, ol.extent.getWidth(currentExtent) * 0.1);

            fetch(jsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Errore nel caricamento del file JSON: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(item => {
                        const coords = ol.proj.fromLonLat([parseFloat(item.lon), parseFloat(item.lat)]);
                        const poiId = `${item.lat}-${item.lon}`; // Identificatore unico per ogni POI

                        // Verifica se il POI √® nella viewport e non √® gi√† stato caricato
                        if (ol.extent.containsCoordinate(bufferedExtent, coords) && !loadedPOIs.has(poiId)) {
                            const poi = {
                                name: {
                                    it: item.name,
                                    en: item.name_en,
                                    fr: item.name_fr,
                                    es: item.name_es
                                },
                                category: item.category,
                                lat: parseFloat(item.lat),
                                lng: parseFloat(item.lon),
                                description: {
                                    it: item.description_it,
                                    en: item.description_en,
                                    fr: item.description_fr,
                                    es: item.description_es,
                                    lat: item.description_lat
                                },
                                img: item.img,
                                imgsrc: item.imgsrc,
                            };
                            createMarker(poi);
                            loadedPOIs.add(poiId); // Aggiungi il POI alla lista dei caricati
                        }
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei dati JSON:', error);
                });
        }

        function createMarker(poi) {
            const coords = ol.proj.fromLonLat([poi.lng, poi.lat]);
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coords),
                name: poi.name,
                description: poi.description,
                category: poi.category,
                lat: poi.lat,
                lng: poi.lng
            });

            const markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    src: `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><text x="12" y="20" font-family="Arial" font-size="20" fill="black" text-anchor="middle">${getIconForCategory(poi.category)}</text></svg>`,
                    scale: 1.8
                })
            });

            marker.setStyle(markerStyle);

            const vectorSource = new ol.source.Vector({
                features: [marker]
            });

            const vectorLayer = new ol.layer.Vector({
                source: vectorSource
            });

            map.addLayer(vectorLayer);

            map.on('click', function(evt) {
                map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    if (feature === marker) {
                        showModal(poi);
                    }
                });
            });
        }
        //associa emoj ai marker in base a categoria
        function getIconForCategory(category) {
            return {
                monumenti: 'üèõÔ∏è',
                chiese: 'üïäÔ∏è',
                edifici: 'üè¢',
                varie: 'üëÅÔ∏è',
                fontane: '‚õ≤',
                statue: 'üóø',
                murales: 'üé®',
            }[category] || '';
        }

        function showModal(poi) {
            const modal = document.getElementById('poiModal');
            const modalTitle = document.getElementById('poiModalLabel');
            const modalBody = document.getElementById('poiModalDescription');
            const routeButton = document.getElementById('routeButton');
            let animationInterval;
            let currentUtterance = null;
            let isPlaying = false;

            // Resetta qualsiasi sintesi vocale in corso
            if (currentUtterance) {
                speechSynthesis.cancel();
                isPlaying = false;
                clearInterval(animationInterval);
            }

            // Funzione per creare l'animazione delle emoji
            function createSpeakingAnimation() {
                const emojis = ['üòÄ', 'üòÆ', 'üòê', 'üòØ', 'üòë', 'üòØ', 'üôÇ', 'üòÄ', 'üôÇ', 'üòÆ', 'üòê', 'üòÄ', 'üòÆ'];
                let currentIndex = 0;

                const modalFooter = document.querySelector('#poiModal .modal-footer');
                const emojiContainer = document.createElement('p');
                emojiContainer.style.fontSize = '38px';
                emojiContainer.style.display = 'inline-block';
                emojiContainer.style.marginLeft = 'auto';
                modalFooter.appendChild(emojiContainer);

                return {
                    start: () => {
                        if (!document.body.contains(emojiContainer)) {
                            modalFooter.appendChild(emojiContainer);
                        }
                        emojiContainer.style.display = 'inline-block';
                        animationInterval = setInterval(() => {
                            emojiContainer.textContent = emojis[currentIndex];
                            currentIndex = (currentIndex + 1) % emojis.length;
                        }, 220);
                    },
                    stop: () => {
                        clearInterval(animationInterval);
                        emojiContainer.style.display = 'none';
                    }
                };
            }

            // Configura il contenuto del modal
            modalTitle.textContent = poi.name[currentLanguage] || poi.name.it;
            modalBody.innerHTML = '';

            const imgElement = document.createElement('img');
            imgElement.src = poi.img;
            imgElement.alt = poi.name[currentLanguage] || poi.name.it;
            imgElement.classList.add('img-fluid');
            modalBody.appendChild(imgElement);

            const imgSrcDiv = document.createElement('div');
            imgSrcDiv.innerHTML = poi.imgsrc;
            imgSrcDiv.style.fontSize = '0.5em';
            imgSrcDiv.style.marginTop = '1em';
            imgSrcDiv.style.marginBottom = '0.1em';
            imgSrcDiv.style.wordWrap = 'break-word';
            imgSrcDiv.style.overflowWrap = 'break-word';
            imgSrcDiv.style.maxWidth = '100%';
            modalBody.appendChild(imgSrcDiv);

            const separator = document.createElement('hr');
            modalBody.appendChild(separator);

            const descriptionParagraph = document.createElement('p');
            descriptionParagraph.textContent = poi.description[currentLanguage] || poi.description.it;
            modalBody.appendChild(descriptionParagraph);

            const speakingAnimation = createSpeakingAnimation();

            // Configura il pulsante audio
            const audioBtn = document.querySelector('#poiModal .modal-footer .btn-outline-secondary');
            audioBtn.innerHTML = '<i class="fas fa-play"></i>';

            function createNewUtterance() {
                const utterance = new SpeechSynthesisUtterance(poi.description[currentLanguage] || poi.description.it);
                const langMap = {
                    'it': 'it-IT',
                    'en': 'en-GB',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'lat': 'it-IT'
                };
                utterance.lang = langMap[currentLanguage];

                utterance.onend = function() {
                    audioBtn.innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                    speakingAnimation.stop();
                    currentUtterance = null;
                };

                return utterance;
            }

            // Gestione del pulsante audio
            audioBtn.onclick = function() {
                if (isPlaying) {
                    // Se sta riproducendo, ferma tutto
                    speechSynthesis.cancel();
                    speakingAnimation.stop();
                    audioBtn.innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                    currentUtterance = null;
                } else {
                    // Se non sta riproducendo, inizia una nuova utterance
                    if (currentUtterance) {
                        speechSynthesis.cancel();
                    }
                    currentUtterance = createNewUtterance();
                    speechSynthesis.speak(currentUtterance);
                    speakingAnimation.start();
                    audioBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    isPlaying = true;
                }
            };

            routeButton.onclick = function() {
                openGoogleMaps(poi.lat, poi.lng);
                // Se sta riproducendo, ferma tutto
                speechSynthesis.cancel();
                speakingAnimation.stop();
                audioBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
                currentUtterance = null;

            };
            routeButton.style.padding = '10px 20px';

            // Gestione chiusura modal
            modal.addEventListener('hidden.bs.modal', function() {
                if (currentUtterance) {
                    speechSynthesis.cancel();
                    audioBtn.innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                    speakingAnimation.stop();
                    currentUtterance = null;
                }
            });

            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        // Definisci le traduzioni per ogni lingua
        const translations = {
            it: {
                title: "MiraRoma",
                content: `
           <strong>MiraRoma</strong> come mai prima d'ora! Una mappa interattiva che ti guider√† tra i tesori storici e artistici della Capitale.
Immagina di passeggiare tra le strade acciottolate, mentre un curatore virtuale ti racconta storie affascinanti su monumenti, statue, palazzi e fontane.
Non solo avrai accesso a informazioni dettagliate su ogni punto di interesse, ma anche aneddoti divertenti e curiosit√† che renderanno ogni visita un'esperienza indimenticabile.
Che tu sia un turista in cerca di avventure o un romano desideroso di riscoprire la propria citt√†, <strong>MiraRoma</strong> ti accompagner√† nelle bellezze senza tempo di Roma.
Creata e mantenuta <strong>Gratis</strong> con passione, per permettere a tutti di riscoprire quelle meraviglie che, nella frenesia quotidiana, troppo spesso diamo per scontate.
`,
                // Dropdown menu items
                dropdownItems: {
                    project: "Progetto",
                    support: "Sostienici ‚ù§Ô∏è",
                    privacy: "Privacy",
                    reportPoi: "Segnala un nuovo punto d'interesse"
                },
                whereQuestion: "Dove?",
                thankYouMessage: "Grazie per il contributo!",
                footerSupport: "Sostieni l'app con una donazione",
                newPoiTitle: "Segnala un nuovo punto d'interesse",
                poiNameLabel: "Nome del punto d'interesse",
                descriptionLabel: "Descrizione",
                submitButton: "Invia segnalazione",
                submitError: "Si √® verificato un errore durante l'invio della segnalazione"
            },
            en: {
                title: "MiraRoma",
                content: `Experience <strong>MiraRoma</strong> like never before! An interactive map that guides you through the Capital's historical and artistic treasures.
Imagine strolling through cobblestone streets while a virtual curator tells you fascinating stories about monuments, statues, palaces, and fountains.
Not only will you have access to detailed information about each point of interest, but also fun anecdotes and curiosities that will make every visit an unforgettable experience.
Whether you're a tourist seeking adventure or a Roman eager to rediscover your city, <strong>MiraRoma</strong> will accompany you through Rome's timeless beauty.
Created and maintained <strong>Gratis</strong> with passion, to allow everyone to rediscover those wonders that, in the rush of daily life, we too often take for granted.`,
                // Dropdown menu items
                dropdownItems: {
                    project: "Project",
                    support: "Support us ‚ù§Ô∏è",
                    privacy: "Privacy",
                    reportPoi: "Report new point of interest"
                },
                whereQuestion: "Where?",
                thankYouMessage: "Thank you for your contribution!",
                footerSupport: "Support the app with a donation",
                newPoiTitle: "Report a new point of interest",
                poiNameLabel: "Point of interest name",
                descriptionLabel: "Description",
                submitButton: "Submit report",
                submitError: "An error occurred while submitting the report"
            },
            fr: {
                title: "MiraRoma",
                content: `D√©couvrez <strong>MiraRoma</strong> comme jamais auparavant ! Une carte interactive qui vous guidera √† travers les tr√©sors historiques et artistiques de la Capitale.
Imaginez-vous fl√¢ner dans les rues pav√©es pendant qu'un conservateur virtuel vous raconte des histoires fascinantes sur les monuments, les statues, les palais et les fontaines.
Non seulement vous aurez acc√®s √† des informations d√©taill√©es sur chaque point d'int√©r√™t, mais aussi √† des anecdotes amusantes et des curiosit√©s qui rendront chaque visite inoubliable.
Que vous soyez un touriste en qu√™te d'aventures ou un Romain d√©sireux de red√©couvrir votre ville, <strong>MiraRoma</strong> vous accompagnera √† travers les beaut√©s intemporelles de Rome.
Cr√©√©e et maintenue <strong>Gratis</strong> avec passion, pour permettre √† tous de red√©couvrir ces merveilles que, dans la fr√©n√©sie du quotidien, nous prenons trop souvent pour acquises.`,
                // Dropdown menu items
                dropdownItems: {
                    project: "Projet",
                    support: "Soutenez-nous ‚ù§Ô∏è",
                    privacy: "Confidentialit√©",
                    reportPoi: "Signaler un nouveau point d'int√©r√™t"
                },
                whereQuestion: "O√π?",
                thankYouMessage: "Merci pour votre contribution!",
                footerSupport: "Soutenez l'application avec un don",
                newPoiTitle: "Signaler un nouveau point d'int√©r√™t",
                poiNameLabel: "Nom du point d'int√©r√™t",
                descriptionLabel: "Description",
                submitButton: "Envoyer le rapport",
                submitError: "Une erreur s'est produite lors de l'envoi du rapport"
            },
            es: {
                title: "MiraRoma",
                content: `¬°Descubre <strong>MiraRoma</strong> como nunca antes! Un mapa interactivo que te guiar√° por los tesoros hist√≥ricos y art√≠sticos de la Capital.
Imagina pasear por calles empedradas mientras un curador virtual te cuenta historias fascinantes sobre monumentos, estatuas, palacios y fuentes.
No solo tendr√°s acceso a informaci√≥n detallada sobre cada punto de inter√©s, sino tambi√©n a an√©cdotas divertidas y curiosidades que har√°n de cada visita una experiencia inolvidable.
Ya seas un turista en busca de aventuras o un romano deseoso de redescubrir tu ciudad, <strong>MiraRoma</strong> te acompa√±ar√° por las bellezas atemporales de Roma.
Creada y mantenida <strong>Gratis</strong> con pasi√≥n, para permitir que todos redescubran esas maravillas que, en el ajetreo diario, damos por sentado con demasiada frecuencia.`,
                // Dropdown menu items
                dropdownItems: {
                    project: "Proyecto",
                    support: "Ap√≥yanos ‚ù§Ô∏è",
                    privacy: "Privacidad",
                    reportPoi: "Informar nuevo punto de inter√©s"
                },
                whereQuestion: "¬øD√≥nde?",
                thankYouMessage: "¬°Gracias por tu contribuci√≥n!",
                footerSupport: "Apoya la aplicaci√≥n con una donaci√≥n",
                newPoiTitle: "Informar de un nuevo punto de inter√©s",
                poiNameLabel: "Nombre del punto de inter√©s",
                descriptionLabel: "Descripci√≥n",
                submitButton: "Enviar informe",
                submitError: "Se produjo un error al enviar el informe"
            }
        };

        // Funzione per cambiare la lingua
        // Gestione dello stato dell'interfaccia durante la selezione del POI


        // Funzione per disabilitare/abilitare elementi dell'interfaccia
        function toggleUIElements(disable) {
            const mainDropdown = document.querySelector('.navbar-brand .dropdown-toggle');
            const langDropdown = document.getElementById('languageSelector');
            const footerLinks = document.querySelectorAll('#sticky-footer a');
            const dropdownItems = document.querySelectorAll('.navbar-brand .dropdown-menu .dropdown-item');

            [mainDropdown, langDropdown, ...dropdownItems].forEach(element => {
                if (disable) {
                    element.setAttribute('disabled', 'disabled');
                    element.style.pointerEvents = 'none';
                    element.style.opacity = '0.6';
                } else {
                    element.removeAttribute('disabled');
                    element.style.pointerEvents = 'auto';
                    element.style.opacity = '1';
                }
            });

            footerLinks.forEach(link => {
                link.style.pointerEvents = disable ? 'none' : 'auto';
                link.style.opacity = disable ? '0.6' : '1';
            });
        }

        // Funzione principale per il cambio lingua


        function changeLanguage(lang) {
            currentLanguage = lang;
            const projectTranslation = translations[lang];

            if (!projectTranslation) return;

            // Salva i layer correnti prima del cambio lingua se in modalit√† selezione
            if (isSelectingLocation) {
                map.getLayers().getArray()
                    .filter(layer => {
                        return layer instanceof ol.layer.Vector && layer !== userPositionMarker;
                    })
                    .forEach(layer => {
                        if (!vectorLayers.includes(layer)) {
                            vectorLayers.push(layer);
                            map.removeLayer(layer);
                        }
                    });
            }

            // Aggiorna l'interfaccia...
            updateMainInterface(projectTranslation);
            updatePOIForm(projectTranslation);
            updateFooter(projectTranslation);
            updateOpenPOIModal(lang);

            // Aggiorna il testo "Where?" se in modalit√† selezione
            if (isSelectingLocation) {
                const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
                dropdownToggle.innerHTML = `<strong>${projectTranslation.whereQuestion}</strong>`;
            }
        }

        // Funzione per aggiornare l'interfaccia principale
        function updateMainInterface(translation) {
            document.querySelector('#progettoModal .modal-title').innerHTML = translation.title;
            document.getElementById('progettoContent').innerHTML = translation.content;

            // Aggiorna i testi del dropdown principale usando la struttura esistente
            const dropdownItems = document.querySelectorAll('.navbar-brand .dropdown-menu .dropdown-item');
            const menuKeys = ['project', 'support', 'privacy', 'reportPoi'];

            dropdownItems.forEach((item, index) => {
                if (menuKeys[index] && translation.dropdownItems[menuKeys[index]]) {
                    item.textContent = translation.dropdownItems[menuKeys[index]];
                }
            });

            // Mantieni il titolo header se non in modalit√† selezione
            if (!isSelectingLocation) {
                document.getElementById('headerTitle').textContent = translation.title;
            }
        }

        // Funzione per aggiornare il form POI
        function updatePOIForm(translation) {
            document.querySelector('#newPOIForm .modal-title').textContent = translation.newPoiTitle;
            document.querySelector('label[for="poiName"]').textContent = translation.poiNameLabel;
            document.querySelector('label[for="poiDescription"]').textContent = translation.descriptionLabel;
            document.querySelector('#poiSubmissionForm button[type="submit"]').textContent = translation.submitButton;
        }

        // Funzione per aggiornare il footer
        function updateFooter(translation) {
            const footerLinks = document.querySelectorAll('#sticky-footer a');
            footerLinks[0].textContent = translation.footerSupport;
        }

        // Funzione per aggiornare il modal POI aperto
        function updateOpenPOIModal(lang) {
            const poiModal = document.getElementById('poiModal');
            if (poiModal.classList.contains('show')) {
                const currentPoiTitle = document.getElementById('poiModalLabel').textContent;
                const currentPoi = findPoiByTitle(currentPoiTitle);

                if (currentPoi) {
                    document.getElementById('poiModalLabel').textContent = currentPoi.name[lang] || currentPoi.name.it;
                    if (speechUtterance && isPlaying) {
                        speechSynthesis.cancel();
                        document.querySelector('#poiModal .modal-footer .btn-outline-secondary').innerHTML =
                            '<i class="fas fa-play"></i>';
                        isPlaying = false;
                    }
                }
            }
        }

        // Gestione del selettore lingua
        document.querySelectorAll('.dropdown-item[data-lang]').forEach(item => {
            item.addEventListener('click', function(event) {
                if (isSelectingLocation) return; // Impedisce il cambio lingua durante la selezione del POI

                const selectedLang = this.dataset.lang;
                const selectedText = this.textContent;

                if (selectedLang) {
                    document.getElementById('languageSelectorText').textContent = selectedText;
                    changeLanguage(selectedLang);
                }
            });
        });

        // Gestione della modalit√† selezione POI
        document.getElementById('addNewPOI').addEventListener('click', function() {
            // Chiudi il dropdown menu dopo il click
            const dropdownMenu = this.closest('.dropdown-menu');
            const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
            const bsDropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
            if (bsDropdown) {
                bsDropdown.hide();
            }

            isSelectingLocation = true;
            toggleUIElements(true);
            dropdownToggle.innerHTML = `<strong>${translations[currentLanguage].whereQuestion}</strong>`;
            dropdownToggle.classList.remove('btn-dark');
            dropdownToggle.classList.add('btn-danger');
        });

        // Gestione della chiusura del form POI
        document.getElementById('newPOIForm').addEventListener('hidden.bs.modal', function() {
            if (!isSubmitting) {
                isSelectingLocation = false;
                toggleUIElements(false);
                const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
                dropdownToggle.innerHTML = `<span id="headerTitle">${translations[currentLanguage].title}</span>`;
                dropdownToggle.classList.remove('btn-danger');
                dropdownToggle.classList.add('btn-dark');
            }
        });

        // Reset della selezione POI
        function resetPOISelection() {
            isSelectingLocation = false;
            toggleUIElements(false);
            const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
            dropdownToggle.innerHTML = `<span id="headerTitle">${translations[currentLanguage].title}</span>`;
            dropdownToggle.classList.remove('btn-danger');
            dropdownToggle.classList.add('btn-dark');

        }

        // Nuova funzione per reset completo UI
        function resetUICompletely() {
            isSelectingLocation = false;

            // Rimuovi solo il marker temporaneo se presente
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Ripristina i layer dei POI
            vectorLayers.forEach(layer => {
                // Verifica che il layer non sia gi√† presente sulla mappa
                if (!map.getLayers().getArray().includes(layer)) {
                    map.addLayer(layer);
                }
            });
            vectorLayers = [];

            // Riabilita tutti gli elementi UI
            toggleUIElements(false);

            // Reset del dropdown principale
            const dropdownToggle = document.querySelector('.navbar-brand .dropdown-toggle');
            dropdownToggle.innerHTML = `<span id="headerTitle">${translations[currentLanguage].title}</span>`;
            dropdownToggle.classList.remove('btn-danger');
            dropdownToggle.classList.add('btn-dark');

            // Riabilita i dropdown
            const mainDropdown = document.querySelector('.navbar-brand .dropdown-toggle');
            const langDropdown = document.getElementById('languageSelector');

            if (mainDropdown) {
                mainDropdown.removeAttribute('disabled');
                mainDropdown.style.pointerEvents = 'auto';
                mainDropdown.style.opacity = '1';
            }

            if (langDropdown) {
                langDropdown.removeAttribute('disabled');
                langDropdown.style.pointerEvents = 'auto';
                langDropdown.style.opacity = '1';
            }

            // Riabilita tutti i dropdown items
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.removeAttribute('disabled');
                item.style.pointerEvents = 'auto';
                item.style.opacity = '1';
            });
        }

        // Imposta il contenuto iniziale in italiano
        changeLanguage('it');


        function openGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Aggiungi listener per il movimento della mappa
        map.on('moveend', function() {
            loadPOIData();
        });

        // Inizializza la mappa caricando i POI iniziali
        loadPOIData();

        // Abilita la rotazione della mappa
        map.addInteraction(new ol.interaction.DragRotate({
            condition: ol.events.condition.altKeyOnly
        }));

        // Aggiungi l'interazione di trascinamento per dispositivi touch
        map.addInteraction(new ol.interaction.DragPan());

        // Aggiungi l'interazione di rotazione con due dita per dispositivi touch
        map.addInteraction(new ol.interaction.Rotate({
            condition: ol.events.condition.touch
        }));

        // Inizializza la geolocalizzazione
        requestGeolocation();
    </script>
</body>

</html>